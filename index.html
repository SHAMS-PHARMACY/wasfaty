<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ÙˆØµÙØªÙŠ | Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„Ø£Ù‚Ø±Ø¨ Ù„Ùƒ</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:#0b1220; color:#fff; margin:0}
    .wrap{max-width:680px; margin:0 auto; padding:20px}
    .card{background:#111a2b; border:1px solid #1f2a44; border-radius:16px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .btn{display:inline-block; padding:14px 18px; border-radius:12px; border:0; cursor:pointer; font-weight:600}
    .btn-primary{background:#21c55d; color:#0b1220}
    .btn-ghost{background:transparent; color:#bcd; border:1px solid #2a3a5f}
    .btn-warning{background:#f59e0b; color:#0b1220}
    .tag{display:inline-block; padding:6px 10px; border-radius:999px; background:#1a2744; color:#9fc}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .muted{color:#b8c4de}
    .ok{color:#21c55d; font-weight:700}
    .warn{color:#f59e0b; font-weight:700}
    select{background:#0f172a; color:#fff; border:1px solid #2a3a5f; border-radius:12px; padding:12px; width:100%}
    .spacer{height:14px}
    .success{background:#0d2215; color:#9ff0b1; border:1px solid #1f6a3a; border-radius:12px; padding:12px 14px; margin-top:10px}
    .note{background:#241a08; color:#ffdca8; border:1px solid #5a3d0b; border-radius:12px; padding:12px 14px; margin-top:10px}
    a{color:#9fd}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="tag">Ø®Ø¯Ù…Ø© ÙˆØµÙØªÙŠ â€“ ØµÙŠØ¯Ù„ÙŠØ§Øª Ø´Ù…Ø³</div>
        <img src="./assets/logo.png" alt="Shams" style="height:40px;opacity:.9" onerror="this.style.display='none'"/>
      </div>

      <h2 style="margin:16px 0 8px">Ø¨Ø¯Ù„ Ù…Ø§ ØªØµØ±Ù ÙˆØµÙØªÙŠ Ø¹Ø§Ø¯ÙŠâ€¦ Ø®Ù„Ù‘Ù‡Ø§ ØªÙÙŠØ¯Ùƒ! ğŸ˜‰</h2>
      <p class="muted">Ù‡Ù†ÙˆØµÙ‘Ù„Ùƒ Ù„Ø£Ù‚Ø±Ø¨ ÙØ±Ø¹. ÙˆÙ„Ùˆ Ø¨Ø¹ÙŠØ¯ Ø¹Ù†ÙƒØŒ Ù‡Ù†Ø±Ø´Ø­ Ø£Ù‚Ø±Ø¨ ÙØ±Ø¹ Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù… ÙÙ‚Ø·.</p>

      <div class="success" id="promo">
        âœ… Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±ÙˆÙŠØ¬ÙŠØ© Ù‡ØªÙØ¶Ù„ Ø¸Ø§Ù‡Ø±Ø© Ù„Ø­Ø¯ Ù…Ø§ ØªØ¨Ø¯Ø£ Ø¨Ù†ÙØ³Ùƒ.
      </div>

      <div class="spacer"></div>

      <!-- Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£ÙˆÙ„Ù‰ -->
      <div id="step-ask" class="row" style="align-items:center; gap:12px">
        <button class="btn btn-primary" id="btnLocate">Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</button>
        <button class="btn btn-ghost" id="btnManual">Ø§Ø®ØªÙŠØ§Ø± ÙŠØ¯ÙˆÙŠ</button>
      </div>

      <!-- Ø§Ø®ØªÙŠØ§Ø± ÙŠØ¯ÙˆÙŠ -->
      <div id="manualBox" style="display:none; margin-top:12px">
        <label class="muted">Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹ ÙŠØ¯ÙˆÙŠÙ‹Ø§ (Ù„Ùˆ Ù…Ù‚ÙÙ„ØªØ´ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹)</label>
        <select id="branchSelect"></select>
        <div class="spacer"></div>
        <button class="btn btn-primary" id="btnGoManual">Ø§Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ±Ø¹</button>
      </div>

      <!-- Ù†ØªÙŠØ¬Ø© Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø£Ù‚Ø±Ø¨ -->
      <div id="resultBox" style="display:none; margin-top:16px">
        <p>Ø£Ù‚Ø±Ø¨ ÙØ±Ø¹ Ù„ÙŠÙƒ: <span id="nearestName" class="ok"></span></p>
        <p class="muted" id="nearestAddr"></p>
        <p class="muted">Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠØ©: <span id="nearestDist" class="ok"></span> ÙƒÙ…</p>

        <!-- Ø¥Ø´Ø¹Ø§Ø± Ù„Ùˆ Ø£Ø¨Ø¹Ø¯ Ù…Ù† Ø§Ù„Ù†Ø·Ø§Ù‚ -->
        <div id="pickupOnlyNote" class="note" style="display:none">
          âš ï¸ <span class="warn">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙØ±Ø¹ Ø¶Ù…Ù† 5 ÙƒÙ… Ù…Ù† Ù…ÙˆÙ‚Ø¹Ùƒ.</span><br>
          ÙŠÙ…ÙƒÙ†Ùƒ ØµØ±Ù Ø§Ù„ÙˆØµÙØ© Ù…Ù† Ø£Ù‚Ø±Ø¨ ÙØ±Ø¹ <b>Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù† Ø§Ù„ÙØ±Ø¹ ÙÙ‚Ø·</b> (Ù„Ø§ ÙŠØªÙˆÙØ± ØªÙˆØµÙŠÙ„ Ù„Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ).
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn btn-primary" id="btnWhatsapp">ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„ÙØ±Ø¹</button>
          <button class="btn btn-ghost" id="btnMaps">Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø®Ø±Ø§Ø¦Ø· Ø¬ÙˆØ¬Ù„</button>
          <button class="btn btn-ghost" id="btnNew">Ø§Ø®ØªÙŠØ§Ø± ÙØ±Ø¹ Ù…Ø®ØªÙ„Ù</button>
        </div>

        <!-- Ø²Ø± ØªÙˆØµÙŠÙ„ Ù„Ù„Ù…Ù†Ø²Ù„ ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ùˆ Ø¯Ø§Ø®Ù„ 5 ÙƒÙ… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) -->
        <div id="deliveryRow" class="row" style="margin-top:10px; display:none">
          <button class="btn btn-warning" id="btnHomeDelivery">Ø·Ù„Ø¨ ØªÙˆØµÙŠÙ„ Ù„Ù„Ù…Ù†Ø²Ù„</button>
        </div>
      </div>

      <div id="status" class="muted" style="margin-top:14px"></div>
    </div>
  </div>

  <script>
  // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© ---
  const DELIVERY_RADIUS_KM = 5; // Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ù„Ù„ØªÙˆØµÙŠÙ„

  // --- Utilities ---
  const R = 6371; // km
  const toRad = d => d * Math.PI / 180;
  function haversine(lat1, lon1, lat2, lon2){
    const dlat = toRad(lat2-lat1), dlon = toRad(lon2-lon1);
    const a = Math.sin(dlat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dlon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  // --- State ---
  let branches = [];
  let nearest = null; // { ...b, distance_km }
  let userPos = null;

  const $ = sel => document.querySelector(sel);
  const elStatus = $("#status");
  const elManualBox = $("#manualBox");
  const elBranchSelect = $("#branchSelect");
  const elResultBox = $("#resultBox");
  const elNearestName = $("#nearestName");
  const elNearestAddr = $("#nearestAddr");
  const elNearestDist = $("#nearestDist");
  const elPickupOnlyNote = $("#pickupOnlyNote");
  const elDeliveryRow = $("#deliveryRow");

  // Load branches
  async function loadBranches(){
    try{
      const res = await fetch("./branches.json?ts="+Date.now());
      if(!res.ok) throw new Error("failed to load branches.json");
      branches = await res.json();
      // Fill manual select
      elBranchSelect.innerHTML = branches.map(b =>
        `<option value="${b.code}">${b.name} â€” ${b.address || ''}</option>`
      ).join("");
    }catch(e){
      console.error(e);
      elStatus.textContent = "ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±ÙˆØ¹. ØªØ£ÙƒÙ‘Ø¯ Ù…Ù† Ù…Ù„Ù branches.json";
    }
  }

  function getNearest(lat, lon){
    let best = null, bestD = Infinity;
    for(const b of branches){
      const d = haversine(lat, lon, b.lat, b.lon);
      if(d < bestD){ bestD = d; best = {...b, distance_km: d}; }
    }
    return best;
  }

  async function locate(){
    elStatus.textContent = "Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒâ€¦";
    return new Promise((resolve, reject)=>{
      if(!navigator.geolocation){
        reject(new Error("Geolocation ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…"));
        return;
      }
      navigator.geolocation.getCurrentPosition(
        pos => resolve({lat: pos.coords.latitude, lon: pos.coords.longitude}),
        err => reject(err),
        { enableHighAccuracy:true, timeout: 12000, maximumAge: 0 }
      );
    });
  }

  function showResult(b, source = "auto"){
    nearest = b;

    elNearestName.textContent = b.name;
    elNearestAddr.textContent = b.address || "";
    elNearestDist.textContent = (b.distance_km ?? 0).toFixed(1);

    // Ù…Ù†Ø·Ù‚ 5 ÙƒÙ…:
    const insideRadius = typeof b.distance_km === "number" ? (b.distance_km <= DELIVERY_RADIUS_KM) : false;

    if(insideRadius){
      // Ø¯Ø§Ø®Ù„ 5 ÙƒÙ… â†’ Ù†ÙƒÙ…Ù„ Ø¹Ø§Ø¯ÙŠ: Ø¥Ø¸Ù‡Ø§Ø± Ø®ÙŠØ§Ø± Ø§Ù„ØªÙˆØµÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
      elPickupOnlyNote.style.display = "none";
      elDeliveryRow.style.display = "flex"; // Ù„Ùˆ Ù…Ø´ Ø¹Ø§ÙŠØ² Ø²Ø± Ø§Ù„ØªÙˆØµÙŠÙ„ØŒ Ø®Ù„Ù‘ÙŠÙ‡Ø§ "none"
    }else{
      // Ø®Ø§Ø±Ø¬ 5 ÙƒÙ… â†’ Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù† Ø§Ù„ÙØ±Ø¹ ÙÙ‚Ø·
      elPickupOnlyNote.style.display = "block";
      elDeliveryRow.style.display = "none";
    }

    elResultBox.style.display = "block";
    elStatus.textContent = "";
  }

  // Events
  $("#btnLocate").addEventListener("click", async ()=>{
    try{
      userPos = await locate();
      const b = getNearest(userPos.lat, userPos.lon);
      if(!b) throw new Error("Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ±ÙˆØ¹ ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§.");
      showResult(b, "auto");
    }catch(e){
      elStatus.textContent = "ØªØ¹Ø°Ù‘Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙŠØ¯ÙˆÙŠ.";
      elManualBox.style.display = "block";
    }
  });

  $("#btnManual").addEventListener("click", ()=>{
    elManualBox.style.display = "block";
    elStatus.textContent = "Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹ ÙŠØ¯ÙˆÙŠÙ‹Ø§.";
  });

  $("#btnGoManual").addEventListener("click", ()=>{
    const code = elBranchSelect.value;
    const b = branches.find(x => x.code === code);
    if(!b){ elStatus.textContent = "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ù…Ø®ØªØ§Ø±."; return; }
    // ÙÙŠ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙŠØ¯ÙˆÙŠØŒ Ù…Ø´ Ù‡Ù†Ø­Ø³Ø¨ Ù…Ø³Ø§ÙØ© Ù„Ùˆ Ù…ÙÙŠØ´ userPos
    // Ù„ÙƒÙ† ÙŠÙØ¶Ù„ Ù†Ø¹Ø±Ø¶Ù‡ ÙƒØ§Ø³ØªÙ„Ø§Ù… ÙÙ‚Ø· (Ø£Ùˆ Ø³ÙŠØ¨Ù‡ Ø¹Ø§Ø¯ÙŠ). Ù‡Ù†Ø§ Ù‡Ù†Ø¸Ù‡Ø±Ù‡ Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø§ÙØ©:
    const bb = {...b, distance_km: (userPos ? haversine(userPos.lat, userPos.lon, b.lat, b.lon) : NaN)};
    showResult(bb, "manual");
  });

  $("#btnWhatsapp").addEventListener("click", ()=>{
    if(!nearest) return;
    const url = `https://wa.me/${nearest.whatsapp}`;
    window.open(url, "_blank", "noopener");
  });

  $("#btnMaps").addEventListener("click", ()=>{
    if(!nearest) return;
    // Ø§ØªØ¬Ø§Ù‡Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„ÙØ±Ø¹: Ù„Ùˆ Ù…Ø¹Ø§Ù†Ø§ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø¹Ù…Ù„ DirectionsØŒ ÙˆØ¥Ù„Ø§ Ù†ÙØªØ­ Pin Ø§Ù„ÙØ±Ø¹ ÙÙ‚Ø·
    const base = "https://www.google.com/maps/dir/?api=1";
    let url = `${base}&destination=${nearest.lat},${nearest.lon}`;
    if(userPos) url += `&origin=${userPos.lat},${userPos.lon}`;
    window.open(url, "_blank", "noopener");
  });

  $("#btnNew").addEventListener("click", ()=>{
    elResultBox.style.display = "none";
    elManualBox.style.display = "block";
    elStatus.textContent = "ØªÙ‚Ø¯Ø± ØªØºÙŠÙ‘Ø± Ø§Ù„ÙØ±Ø¹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.";
  });

  // Ø²Ø± ØªÙˆØµÙŠÙ„ Ù„Ù„Ù…Ù†Ø²Ù„ (Ù„Ùˆ Ø¯Ø§Ø®Ù„ 5 ÙƒÙ…) â€” Ù‡Ù†Ø§ Ù…Ø¬Ø±Ø¯ Placeholder Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠ
  $("#btnHomeDelivery").addEventListener("click", ()=>{
    if(!nearest) return;
    alert("Ø®Ø¯Ù…Ø© Ø§Ù„ØªÙˆØµÙŠÙ„ Ù…ØªØ§Ø­Ø© Ù„Ø¹Ù†ÙˆØ§Ù†Ùƒ. Ø£ÙƒÙ…Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø®Ù„Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„ÙØ±Ø¹ ÙˆØ³ÙŠØªÙ… Ø§Ù„ØªÙ†Ø³ÙŠÙ‚.");
    // ØªÙ‚Ø¯Ø± Ù‡Ù†Ø§ ØªÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø±Ø³Ø§Ù„Ø© Ù…Ø­Ø¯Ø¯Ø© Ù„Ù„ØªÙˆØµÙŠÙ„ Ø£Ùˆ ØªØ¹Ø±Ø¶ ÙÙˆØ±Ù… Ø¥Ø¶Ø§ÙÙŠâ€¦
  });

  // Init
  loadBranches();
  </script>
</body>
</html>
